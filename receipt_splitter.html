<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-light text-gray-900 mb-2">Receipt Splitter</h1>
                <p class="text-gray-500">Upload a receipt, assign items, split the bill</p>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection" class="bg-white rounded-xl shadow-sm p-12">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-gray-600 mb-2">Select your receipt image</p>
                    <input type="file" id="fileInput" class="hidden" accept="image/jpeg,image/png">
                    <label for="fileInput" class="inline-block px-4 py-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600 transition-colors">
                        Browse Files
                    </label>
                    <p class="text-sm text-gray-400 mt-4">Supports JPG, PNG</p>
                    <button onclick="useDemoData()" class="mt-4 text-sm text-blue-500 hover:text-blue-600">
                        Use Demo Receipt
                    </button>
                </div>
            </div>

            <!-- Main Content (hidden initially) -->
            <div id="mainContent" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Receipt Details -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-medium mb-4">ðŸ“„ Receipt Details</h2>
                        <div id="vendorInfo" class="mb-4 pb-4 border-b"></div>
                        <div id="itemsList" class="space-y-3"></div>
                        <div id="totalsSection" class="mt-4 pt-4 border-t"></div>
                    </div>
                </div>

                <!-- People & Split -->
                <div class="space-y-6">
                    <!-- People Management -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-medium mb-4">ðŸ‘¥ People</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="personInput" placeholder="Add person..." 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addPerson()" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                +
                            </button>
                        </div>
                        <div id="peopleList" class="space-y-2"></div>
                        <button onclick="calculateSplit()" class="w-full mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            Calculate Split
                        </button>
                    </div>

                    <!-- Split Results -->
                    <div id="splitResults" class="hidden bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-medium mb-4">âœ… Split Summary</h2>
                        <div id="breakdownList" class="space-y-3"></div>
                    </div>

                    <button onclick="resetAll()" class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Start New Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let receiptData = null;
        let assignments = {};
        let people = [];

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('personInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPerson();
        });

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('https://receipt-ocr-1050175412544.us-central1.run.app/api/extract-receipt', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to extract receipt');
                
                const data = await response.json();
                displayReceipt(data);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to process receipt. Using demo data instead.');
                useDemoData();
            }
        }

        function useDemoData() {
            const demoReceipt = {
                vendor: "MIKEY'S ITALIAN RESTAURANT",
                datetime: "24/04/2024 18:37",
                items: [
                    { name: "Minestrone", qty: 1, unit_price: 6.00, line_total: 6.00 },
                    { name: "Lasagna", qty: 1, unit_price: 15.00, line_total: 15.00 },
                    { name: "Margherita", qty: 1, unit_price: 11.00, line_total: 11.00 },
                    { name: "Tiramisu", qty: 1, unit_price: 7.00, line_total: 7.00 },
                    { name: "House Red", qty: 1, unit_price: 19.00, line_total: 19.00 }
                ],
                subtotal: 58.00,
                tax: null,
                tip: 5.80,
                total: 63.80
            };
            people = ['Alex', 'Tony', 'Chris', 'Aaron', 'John'];
            displayReceipt(demoReceipt);
            updatePeopleList();
        }

        function displayReceipt(data) {
            receiptData = data;
            assignments = {};
            
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            // Vendor info
            document.getElementById('vendorInfo').innerHTML = `
                <p class="font-medium text-gray-900">${data.vendor || 'Unknown Vendor'}</p>
                <p class="text-sm text-gray-500">${data.datetime || 'No date'}</p>
            `;

            // Items list
            const itemsHtml = data.items.map((item, idx) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">Qty: ${item.qty} Ã— Â£${item.unit_price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-medium">Â£${item.line_total.toFixed(2)}</span>
                        <select id="assign-${idx}" onchange="assignItem(${idx}, this.value)"
                                class="px-3 py-1 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                </div>
            `).join('');
            document.getElementById('itemsList').innerHTML = itemsHtml;

            // Totals
            let totalsHtml = `
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Subtotal</span>
                        <span>Â£${data.subtotal.toFixed(2)}</span>
                    </div>`;
            
            if (data.tax) {
                totalsHtml += `
                    <div class="flex justify-between text-sm">
                        <span>Tax</span>
                        <span>Â£${data.tax.toFixed(2)}</span>
                    </div>`;
            }
            
            if (data.tip) {
                totalsHtml += `
                    <div class="flex justify-between text-sm">
                        <span>Service/Tip</span>
                        <span>Â£${data.tip.toFixed(2)}</span>
                    </div>`;
            }
            
            totalsHtml += `
                    <div class="flex justify-between font-medium text-lg pt-2">
                        <span>Total</span>
                        <span>Â£${data.total.toFixed(2)}</span>
                    </div>
                </div>`;
            
            document.getElementById('totalsSection').innerHTML = totalsHtml;
            updateAssignmentDropdowns();
        }

        function addPerson() {
            const input = document.getElementById('personInput');
            const name = input.value.trim();
            
            if (name && !people.includes(name)) {
                people.push(name);
                input.value = '';
                updatePeopleList();
                updateAssignmentDropdowns();
            }
        }

        function removePerson(person) {
            people = people.filter(p => p !== person);
            // Remove assignments for this person
            Object.keys(assignments).forEach(key => {
                if (assignments[key] === person) {
                    delete assignments[key];
                    document.getElementById(`assign-${key}`).value = '';
                }
            });
            updatePeopleList();
            updateAssignmentDropdowns();
        }

        function updatePeopleList() {
            const html = people.length > 0 ? people.map(person => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <span class="text-sm font-medium">${person}</span>
                    <button onclick="removePerson('${person}')" class="text-red-500 hover:text-red-600">Ã—</button>
                </div>
            `).join('') : '<p class="text-sm text-gray-400 text-center py-4">No people added yet</p>';
            
            document.getElementById('peopleList').innerHTML = html;
        }

        function updateAssignmentDropdowns() {
            if (!receiptData) return;
            
            receiptData.items.forEach((_, idx) => {
                const select = document.getElementById(`assign-${idx}`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Unassigned</option>' + 
                        people.map(person => `<option value="${person}">${person}</option>`).join('');
                    select.value = currentValue;
                }
            });
        }

        function assignItem(itemIndex, person) {
            if (person) {
                assignments[itemIndex] = person;
            } else {
                delete assignments[itemIndex];
            }
        }

        function calculateSplit() {
            if (Object.keys(assignments).length === 0) {
                alert('Please assign items to people first');
                return;
            }

            // Get unique people who have items assigned
            const assignedPeople = [...new Set(Object.values(assignments))];
            const numPeople = assignedPeople.length;

            if (numPeople === 0) {
                alert('No people assigned to items');
                return;
            }

            // Calculate shared costs (tax + tip/service charge)
            const sharedCosts = (receiptData.tax || 0) + (receiptData.tip || 0);
            const sharedPerPerson = sharedCosts / numPeople;
            
            // Initialize person totals and items tracking
            const personTotals = {};
            const personItems = {};
            
            assignedPeople.forEach(person => {
                personTotals[person] = 0;
                personItems[person] = [];
            });

            // Add up items for each person
            Object.entries(assignments).forEach(([idx, person]) => {
                const itemIndex = parseInt(idx);
                if (itemIndex >= 0 && itemIndex < receiptData.items.length) {
                    const item = receiptData.items[itemIndex];
                    personTotals[person] += item.line_total;
                    personItems[person].push(item.name);
                }
            });

            // Create final breakdown
            const breakdown = assignedPeople.map(person => ({
                name: person,
                items: personItems[person],
                items_total: personTotals[person],
                shared_costs: sharedPerPerson,
                total: personTotals[person] + sharedPerPerson
            }));

            // Display the results
            displaySplitResults({
                breakdown,
                total_bill: receiptData.total,
                shared_costs: sharedCosts,
                num_people: numPeople
            });
        }

        function displaySplitResults(result) {
            let html = result.breakdown.map(person => `
                <div class="p-3 bg-green-50 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium">${person.name}</span>
                        <span class="text-lg font-bold">Â£${person.total.toFixed(2)}</span>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        <p>Items: ${person.items.join(', ')}</p>
                        <p>Items total: Â£${person.items_total.toFixed(2)}</p>
                        <p>Share of service/tax: Â£${person.shared_costs.toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
            
            // Add summary information
            html += `
                <div class="mt-4 pt-4 border-t text-sm text-gray-600">
                    <p>Total bill: Â£${result.total_bill.toFixed(2)}</p>
                    <p>Shared costs: Â£${result.shared_costs.toFixed(2)}</p>
                    <p>Split between: ${result.num_people} ${result.num_people === 1 ? 'person' : 'people'}</p>
                </div>
            `;
            
            document.getElementById('breakdownList').innerHTML = html;
            document.getElementById('splitResults').classList.remove('hidden');
        }

        function resetAll() {
            receiptData = null;
            assignments = {};
            people = [];
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('splitResults').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }
    </script>
</body>
</html>